<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>"CAL-MAT" (2 min)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 24px;
      background: linear-gradient(135deg,#ffecd2,#fcb69f);
      min-height: 100vh;
      box-sizing: border-box;
    }
    .card {
      display: inline-block;
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 22px rgba(0,0,0,0.14);
      max-width: 420px;
      width: 94%;
    }
    input { width: 90%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }
    button { padding: 10px 18px; border-radius: 8px; border: none; background: #ff7f50; color: #fff; font-weight: 600; cursor: pointer; }
    button[disabled] { opacity: 0.6; cursor: default; }
    #status { margin-top: 10px; color: #444; font-size: 0.95rem; }
    #result { margin-top: 14px; font-size: 1.15rem; font-weight: 600; color: #222; min-height: 1.3em; }
    small { color: #666; display:block; margin-top:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>"CAL-MAT"</h2>
    <input id="expression" placeholder="Enter expression (e.g. 5+3 * 2)" />
    <br>
    <button id="listenBtn">üéôÔ∏è Listen & Calculate (2 min)</button>
    <div id="status">Click the button and allow microphone access.</div>
    <div id="result"></div>
    <small>Wait and see what happens‚Ä¶</small>
  </div>

  <script>
  const listenBtn = document.getElementById('listenBtn');
  const status = document.getElementById('status');
  const resultDiv = document.getElementById('result');
  const listenDuration = 120000; // 2 minutes in ms
  const THRESHOLD = 0.02;


function playBeep() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();

    oscillator.type = "square";
    oscillator.frequency.setValueAtTime(600, ctx.currentTime); // Hz
    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);

    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);

    oscillator.start();
    oscillator.stop(ctx.currentTime + 0.2); // 0.2 sec beep
listenBtn.addEventListener('click', () => {
  playBeep(); // ‚úÖ User gesture ‚Üí sound allowed
  startListening();
});
  }

  const prankMessages = [
    "Your silence has been calculated... it's zero.",
    "No sound detected, so here's a random potato.",
    "Result: Undefined, like your social life.",
    "I heard crickets. Literally.",
    "Try speaking louder next time, mime artist!"
  ];
  const motivationalQuotes = [
    "Push yourself ‚Äî no one else will!",
    "Believe you can, you're halfway there!",
    "Success is the sum of small efforts.",
    "The harder you work, the luckier you get."
  ];
  const sillyQuotes = [
    "Pizza solves more problems than division.",
    "Quack! You just divided your happiness.",
    "I tried dividing by zero once‚Ä¶ it was infinite fun.",
    "Why did the math book look sad? Too many problems."
  ];

  function safeEval(expr) {
    if (!expr || !expr.trim()) throw new Error('empty');
    expr = expr.replace(/\^/g, '**').trim();
    if (!/^[0-9+\-*/().\s%]+$/.test(expr)) throw new Error('invalid chars');
    const val = Function('"use strict"; return (' + expr + ')')();
    if (typeof val === 'number' && isFinite(val)) return val;
    throw new Error('bad result');
  }

  function showPrank() {
    const prank = prankMessages[Math.floor(Math.random()*prankMessages.length)];
    resultDiv.innerText = prank;
    status.innerText = 'Done.';
  }

  function calculateWithQuotes() {
    const expression = document.getElementById('expression').value.trim();
    if (expression.includes('*')) {
      resultDiv.innerText = motivationalQuotes[Math.floor(Math.random()*motivationalQuotes.length)];
      status.innerText = 'Done.';
      return;
    }
    if (expression.includes('/')) {
      resultDiv.innerText = sillyQuotes[Math.floor(Math.random()*sillyQuotes.length)];
      status.innerText = 'Done.';
      return;
    }
    try {
      const res = safeEval(expression);
      resultDiv.innerText = res;
      status.innerText = 'Done.';
    } catch {
      resultDiv.innerText = 'Invalid expression.';
      status.innerText = 'Done.';
    }
  }

  async function startSoundDetection(durationMs = listenDuration) {
    resultDiv.innerText = '';
    status.innerText = 'Listening...';
    listenBtn.disabled = true;

    let stream, audioCtx, analyser, source, dataArr, rafId;
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch {
      status.innerText = 'Microphone access denied.';
      listenBtn.disabled = false;
      return;
    }

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    source.connect(analyser);
    dataArr = new Float32Array(analyser.fftSize);

    const endTime = Date.now() + durationMs;

    function getRMS() {
      analyser.getFloatTimeDomainData(dataArr);
      let sum = 0;
      for (let i = 0; i < dataArr.length; i++) sum += dataArr[i] * dataArr[i];
      return Math.sqrt(sum / dataArr.length);
    }

    function tick() {
      const rms = getRMS();
      if (rms > THRESHOLD) {
        cleanup(true);
        return;
      }
      if (Date.now() >= endTime) {
        cleanup(false);
        return;
      }
      rafId = requestAnimationFrame(tick);
    }

    function cleanup(didHear) {
      if (rafId) cancelAnimationFrame(rafId);
      source.disconnect();
      analyser.disconnect();
      audioCtx.close();
      stream.getTracks().forEach(t => t.stop());
      listenBtn.disabled = false;
      setTimeout(() => {
        if (didHear) calculateWithQuotes();
        else showPrank();
      }, 150);
    }

    tick();
  }

  listenBtn.addEventListener('click', () => startSoundDetection(listenDuration));

  </script>
</body>
</html>
